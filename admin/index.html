<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Admin | Netlify CMS</title>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Esperar a que Netlify CMS esté cargado
      if (typeof CMS !== 'undefined') {
        CMS.registerEventListener({
          name: 'preSave',
          handler: ({ entry }) => {
            // Generar código solo para nuevos productos
            if (!entry.get('data').get('code')) {
              const now = new Date();
              const code = 'PROD-' + now.getFullYear() + 
                           String(now.getMonth() + 1).padStart(2, '0') + 
                           String(now.getDate()).padStart(2, '0') + '-' +
                           String(now.getHours()).padStart(2, '0') +
                           String(now.getMinutes()).padStart(2, '0') +
                           String(now.getSeconds()).padStart(2, '0');
              return entry.get('data').set('code', code);
            }
            return entry.get('data');
          }
        });

        // Nuevo: Evento postSave para notificación
        CMS.registerEventListener({
          name: 'postSave',
          handler: ({ entry }) => {
            if (entry.get('collection') === 'productos') {
              const product = entry.get('data').toJS();
              const message = `🆕 *Nuevo Producto* 🛍️\n\n` +
                             `*${product.title}*\n` +
                             `Precio: S/${product.price.toFixed(2)}\n` +
                             `Código: ${product.code}\n` +
                             `Categoría: ${product.category}\n\n` +
                             `Ver en catálogo: ${window.location.origin}`;
              
              // Abre pestaña con enlace a WhatsApp (solución semi-automática)
              window.open(
                `https://web.whatsapp.com/send?text=${encodeURIComponent(message)}&phone=51940243849`,
                '_blank'
              );
            }
          }
        });
      }
    });
  </script>
</head>
<body>
  <div id="nc-root"></div>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
</body>
</html>
